# .envrc for ALEX-STACK with 1Password CLI Integration
# ============================================
# Vault: AI DEV
# Auto-loads secrets from 1Password vault for Claude Code MCP servers
#
# Prerequisites:
# - 1Password CLI installed: brew install 1password-cli
# - Authenticated: op signin
# - Vault items created (see VAULT_SETUP.md)
#
# Usage:
# 1. Ensure prerequisites are met
# 2. Run: direnv allow
# 3. Verify: echo $JINA_API_KEY

# ============================================
# 1PASSWORD VAULT CONFIGURATION
# ============================================
VAULT_NAME="AI DEV"  # Your 1Password vault for AI/Dev credentials

# ============================================
# PROJECT SETTINGS
# ============================================
export CLAUDE_PROJECT_ROOT="$(pwd)"
export NODE_ENV="${NODE_ENV:-development}"

# ============================================
# 1PASSWORD CLI INTEGRATION
# ============================================

# Check if 1Password CLI is available and authenticated
if command -v op >/dev/null 2>&1; then
  # Test authentication by listing vaults
  if op vault list >/dev/null 2>&1; then
    # ============================================
    # LOAD SECRETS FROM 1PASSWORD VAULT: AI DEV
    # ============================================

    # Jina AI MCP Server - Web research and content extraction
    # 1Password item: "Jina.ai" in vault "AI DEV"
    # Field: api_key
    export JINA_API_KEY="$(op read "op://${VAULT_NAME}/Jina.ai/api_key" 2>/dev/null)"

    # Notion MCP Server - Workspace integration
    # 1Password item: "Notion MCP Suekou" in vault "AI DEV"
    # Field: token
    export NOTION_API_TOKEN="$(op read "op://${VAULT_NAME}/Notion MCP Suekou/token" 2>/dev/null)"

    # ============================================
    # OPTIONAL: ADDITIONAL SERVICES
    # ============================================

    # Anthropic API (if using Claude API directly)
    # Create item: op item create --category=login --title="Anthropic" --vault="AI DEV" api_key="your_key"
    # export ANTHROPIC_API_KEY="$(op read "op://${VAULT_NAME}/Anthropic/api_key" 2>/dev/null)"

    # GitHub CLI / API access
    # export GITHUB_TOKEN="$(op read "op://${VAULT_NAME}/GitHub/token" 2>/dev/null)"

    # OpenAI (if using alongside Claude)
    # export OPENAI_API_KEY="$(op read "op://${VAULT_NAME}/OpenAI/api_key" 2>/dev/null)"

    echo "✅ Secrets loaded from 1Password vault: ${VAULT_NAME}"

  else
    # 1Password CLI exists but not authenticated
    echo "⚠️  1Password CLI not authenticated"
    echo "   Run: op signin"
    echo "   Then: direnv allow"
    echo ""
    echo "   Falling back to .envrc.local if available..."

    # Fallback to .envrc.local
    if [ -f .envrc.local ]; then
      source_env .envrc.local
      echo "✅ Using .envrc.local (manual credentials)"
    else
      echo "❌ No .envrc.local found"
      echo "   Create .envrc.local with your API keys, or"
      echo "   Authenticate 1Password CLI: op signin"
    fi
  fi
else
  # 1Password CLI not installed
  echo "⚠️  1Password CLI not found"
  echo "   Install: brew install 1password-cli"
  echo "   Or use .envrc.local for manual credentials"
  echo ""

  # Fallback to .envrc.local
  if [ -f .envrc.local ]; then
    source_env .envrc.local
    echo "✅ Using .envrc.local (manual credentials)"
  else
    echo "❌ No credentials available!"
    echo ""
    echo "   Option 1 (Recommended): Install 1Password CLI"
    echo "     brew install 1password-cli"
    echo "     op signin"
    echo "     direnv allow"
    echo ""
    echo "   Option 2: Create .envrc.local with manual credentials"
    echo "     cp .envrc.local.example .envrc.local"
    echo "     # Edit .envrc.local with your API keys"
    echo "     direnv allow"
  fi
fi

# ============================================
# PLAYWRIGHT MCP SERVER
# ============================================
# Playwright runs locally, no credentials needed
# Automatically configured in .mcp.json

# ============================================
# VERIFICATION
# ============================================
# Check that required variables are set
required_vars=(
  "JINA_API_KEY"
  "NOTION_API_TOKEN"
)

missing_vars=()
for var in "${required_vars[@]}"; do
  if [ -z "${!var}" ]; then
    missing_vars+=("$var")
  fi
done

if [ ${#missing_vars[@]} -gt 0 ]; then
  echo ""
  echo "⚠️  Missing required environment variables:"
  for var in "${missing_vars[@]}"; do
    echo "   - $var"
  done
  echo ""
  echo "   Check your 1Password vault 'AI DEV' or .envrc.local"
  echo ""
  echo "   To create items in 1Password vault 'AI DEV':"
  echo "   See VAULT_SETUP.md for instructions"
fi

# ============================================
# NOTES
# ============================================
#
# This .envrc file contains NO secrets - only references to 1Password vault.
# It's safe to commit to Git!
#
# File Structure:
# - .envrc                    (this file - safe to commit)
# - .envrc.local             (manual fallback - NEVER commit)
# - .envrc.local.example     (template for team - safe to commit)
#
# Rotating Keys (with 1Password):
#   op item edit "Jina.ai" api_key="new_key" --vault "AI DEV"
#   direnv allow  # Updates instantly!
#
# ============================================
