# .envrc for ALEX-STACK with 1Password CLI Integration
# ============================================
# Vault: AI DEV
# Auto-loads secrets from 1Password vault for Claude Code MCP servers
#
# Prerequisites:
# - 1Password CLI installed: brew install 1password-cli
# - Authenticated: op signin
# - Vault items created with proper references
#
# Usage:
# 1. Setup 1Password CLI: op signin
# 2. Run: direnv allow
# 3. Verify: echo $JINA_API_KEY

# ============================================
# 1PASSWORD VAULT CONFIGURATION
# ============================================
VAULT_NAME="AI DEV"  # Your 1Password vault for AI/Dev credentials

# ============================================
# PROJECT SETTINGS
# ============================================
export CLAUDE_PROJECT_ROOT="$(pwd)"
export NODE_ENV="${NODE_ENV:-development}"

# ============================================
# 1PASSWORD CLI INTEGRATION WITH FALLBACK
# ============================================

# Check if 1Password CLI is available and authenticated
if command -v op >/dev/null 2>&1; then
  if op vault list >/dev/null 2>&1; then
    # 1Password CLI is available and authenticated
    # Load Jina API Key from vault (field: credential)
    JINA_API_KEY_VALUE="$(op read "op://${VAULT_NAME}/JINA.AI API key/credential" 2>/dev/null || echo "")"
    if [ -n "${JINA_API_KEY_VALUE}" ]; then
      export JINA_API_KEY="${JINA_API_KEY_VALUE}"
    fi

    # Load Notion API Token from vault (field: TOKEN - uppercase)
    NOTION_API_TOKEN_VALUE="$(op read "op://${VAULT_NAME}/NOTION SUEKOU MCP server/TOKEN" 2>/dev/null || echo "")"
    if [ -n "${NOTION_API_TOKEN_VALUE}" ]; then
      export NOTION_API_TOKEN="${NOTION_API_TOKEN_VALUE}"
    fi

    if [ -n "${JINA_API_KEY_VALUE}" ] || [ -n "${NOTION_API_TOKEN_VALUE}" ]; then
      echo "✅ Secrets loaded from 1Password vault: ${VAULT_NAME}"
    else
      echo "⚠️  No secrets found in 1Password vault"
    fi

  else
    # 1Password CLI exists but not authenticated
    echo "⚠️  1Password CLI not authenticated"
    echo "   Run: op signin"
    echo "   Then: direnv allow"
  fi
else
  # 1Password CLI not installed
  echo "⚠️  1Password CLI not installed"
  echo "   Install with: brew install 1password-cli (macOS)"
  echo "                 or see: https://developer.1password.com/docs/cli/get-started"
fi

# Fallback to .envrc.local if credentials not loaded from 1Password
if [ -z "${JINA_API_KEY:-}" ] && [ -z "${NOTION_API_TOKEN:-}" ]; then
  if [ -f .envrc.local ]; then
    echo "   Falling back to .envrc.local..."
    source_env .envrc.local
  else
    echo "   No .envrc.local found"
    echo "   Create one from: cp .envrc.local.example .envrc.local"
  fi
fi

# ============================================
# OPTIONAL: ADDITIONAL SERVICES
# ============================================

# Anthropic API (if using Claude API directly)
# Create item: op item create --category=login --title="Anthropic" --vault="AI DEV" api_key="your_key"
# export ANTHROPIC_API_KEY="$(op read "op://${VAULT_NAME}/Anthropic/api_key" 2>/dev/null)"

# GitHub CLI / API access
# export GITHUB_TOKEN="$(op read "op://${VAULT_NAME}/GitHub/token" 2>/dev/null)"

# OpenAI (if using alongside Claude)
# export OPENAI_API_KEY="$(op read "op://${VAULT_NAME}/OpenAI/api_key" 2>/dev/null)"

# ============================================
# PLAYWRIGHT MCP SERVER
# ============================================
# Playwright runs locally, no credentials needed
# Automatically configured in .mcp.json

# ============================================
# VERIFICATION
# ============================================
# Optional: Uncomment to verify credentials are loaded
# echo "Checking required environment variables..."
# if [ -n "${JINA_API_KEY:-}" ]; then echo "✅ JINA_API_KEY loaded"; else echo "❌ JINA_API_KEY missing"; fi
# if [ -n "${NOTION_API_TOKEN:-}" ]; then echo "✅ NOTION_API_TOKEN loaded"; else echo "❌ NOTION_API_TOKEN missing"; fi

# ============================================
# NOTES
# ============================================
#
# This .envrc file contains NO secrets - only references to 1Password vault.
# It's safe to commit to Git!
#
# File Structure:
# - .envrc                    (this file - safe to commit)
# - .envrc.local             (manual fallback - NEVER commit, in .gitignore)
# - .envrc.local.example     (template for team - safe to commit)
#
# Rotating Keys (with 1Password):
#   op item edit "Jina.ai" api_key="new_key" --vault "AI DEV"
#   direnv allow  # Updates instantly!
#
# ============================================
