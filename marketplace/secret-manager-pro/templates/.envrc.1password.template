# .envrc for Claude Code with 1Password CLI Integration
# ============================================
# AUTO-GENERATED TEMPLATE
# ============================================
#
# This template provides secure secret management using:
# - 1Password CLI (primary, recommended)
# - .envrc.local fallback (for users without 1Password)
#
# Prerequisites:
# 1. Install 1Password CLI: brew install 1password-cli
# 2. Authenticate: op signin
# 3. Create vault items for each service
# 4. Install direnv: brew install direnv
# 5. Setup shell hook: eval "$(direnv hook bash)"
#
# Usage:
# 1. Copy this template to your project root as .envrc
# 2. Customize VAULT_NAME and item references
# 3. Run: direnv allow
# 4. Verify: echo $JINA_API_KEY

# ============================================
# CONFIGURATION
# ============================================

# Your 1Password vault name
# Default: "AI DEV". Change this to match your vault name (e.g., "Private", "Development")
VAULT_NAME="${OP_VAULT_NAME:-AI DEV}"

# Project settings
export CLAUDE_PROJECT_ROOT="$(pwd)"
export NODE_ENV="${NODE_ENV:-development}"

# ============================================
# 1PASSWORD CLI INTEGRATION
# ============================================

# Function to safely read from 1Password
op_read_safe() {
  local vault="$1"
  local item="$2"
  local field="$3"

  if op read "op://${vault}/${item}/${field}" 2>/dev/null; then
    return 0
  else
    echo "" >&2
    return 1
  fi
}

# Fail fast on errors and undefined vars; allow commands explicitly guarded with `|| true`
set -euo pipefail

# Check if 1Password CLI is available and authenticated
if command -v op >/dev/null 2>&1; then
  # Test authentication by listing vaults
  if op vault list >/dev/null 2>&1; then
    # ============================================
    # LOAD SECRETS FROM 1PASSWORD VAULT
    # ============================================

    # Jina AI - Web research and content extraction
    JINA_API_KEY_VALUE="$(op read "op://${VAULT_NAME}/Jina.ai/api_key" 2>/dev/null || true)"
    if [ -n "${JINA_API_KEY_VALUE}" ]; then
      export JINA_API_KEY="${JINA_API_KEY_VALUE}"
    else
      echo "⚠️  Unable to read 'Jina.ai/api_key' from vault '${VAULT_NAME}'. Run 'op signin' or verify item/field names." >&2
      echo "❌ Aborting environment load due to missing required secret: JINA_API_KEY" >&2
      exit 1
    fi

    NOTION_API_TOKEN_VALUE="$(op read "op://${VAULT_NAME}/Notion MCP Suekou/token" 2>/dev/null || true)"
    if [ -n "${NOTION_API_TOKEN_VALUE}" ]; then
      export NOTION_API_TOKEN="${NOTION_API_TOKEN_VALUE}"
    else
      echo "⚠️  Unable to read 'Notion MCP Suekou/token' from vault '${VAULT_NAME}'. Run 'op signin' or verify item/field names." >&2
      echo "❌ Aborting environment load due to missing required secret: NOTION_API_TOKEN" >&2
      exit 1
    fi

    echo "✅ Secrets loaded from 1Password vault: ${VAULT_NAME}"

  else
    # 1Password CLI exists but not authenticated
    echo "⚠️  1Password CLI not authenticated"
    echo "   Run: op signin"
    echo "   Then: direnv allow"
    echo ""
    echo "   Falling back to .envrc.local if available..."

    # Fallback to .envrc.local
    if [ -f .envrc.local ]; then
      # shellcheck disable=SC1091
      source_env .envrc.local
      echo "✅ Using .envrc.local (manual credentials)"
    else
      echo "❌ No .envrc.local found" >&2
      echo "   Create .envrc.local with your API keys, or" >&2
      echo "   Authenticate 1Password CLI: op signin" >&2
      exit 1
    fi
  fi
else
  # 1Password CLI not installed
  echo "⚠️  1Password CLI not found"
  echo "   Install: brew install 1password-cli"
  echo "   Or use .envrc.local for manual credentials"
  echo ""

  # Fallback to .envrc.local
  if [ -f .envrc.local ]; then
    # shellcheck disable=SC1091
    source_env .envrc.local
    echo "✅ Using .envrc.local (manual credentials)"
  else
    echo "❌ No credentials available!" >&2
    echo "   Option 1 (Recommended): Install 1Password CLI" >&2
    echo "   Option 2: Create .envrc.local with manual credentials" >&2
    exit 1
  fi
fi

    # ============================================
    # OPTIONAL: ADDITIONAL SERVICES
    # ============================================

    # Anthropic API (if using Claude API directly)
    # export ANTHROPIC_API_KEY="$(op read "op://${VAULT_NAME}/Anthropic/api_key")"

    # GitHub CLI / API access
    # export GITHUB_TOKEN="$(op read "op://${VAULT_NAME}/GitHub/token")"

    # OpenAI (if using alongside Claude)
    # export OPENAI_API_KEY="$(op read "op://${VAULT_NAME}/OpenAI/api_key")"

    # AWS Credentials
    # export AWS_ACCESS_KEY_ID="$(op read "op://${VAULT_NAME}/AWS/access_key_id")"
    # export AWS_SECRET_ACCESS_KEY="$(op read "op://${VAULT_NAME}/AWS/secret_access_key")"

    echo "✅ Secrets loaded from 1Password vault: ${VAULT_NAME}"

  else
    # 1Password CLI exists but not authenticated
    echo "⚠️  1Password CLI not authenticated"
    echo "   Run: op signin"
    echo "   Then: direnv allow"
    echo ""
    echo "   Falling back to .envrc.local if available..."

    # Fallback to .envrc.local
    if [ -f .envrc.local ]; then
      source_env .envrc.local
      echo "✅ Using .envrc.local (manual credentials)"
    else
      echo "❌ No .envrc.local found"
      echo "   Create .envrc.local with your API keys, or"
      echo "   Authenticate 1Password CLI: op signin"
    fi
  fi
else
  # 1Password CLI not installed
  echo "⚠️  1Password CLI not found"
  echo "   Install: brew install 1password-cli"
  echo "   Or use .envrc.local for manual credentials"
  echo ""

  # Fallback to .envrc.local
  if [ -f .envrc.local ]; then
    source_env .envrc.local
    echo "✅ Using .envrc.local (manual credentials)"
  else
    echo "❌ No credentials available!"
    echo ""
    echo "   Option 1 (Recommended): Install 1Password CLI"
    echo "     brew install 1password-cli"
    echo "     op signin"
    echo "     direnv allow"
    echo ""
    echo "   Option 2: Create .envrc.local with manual credentials"
    echo "     cp .envrc.local.example .envrc.local"
    echo "     # Edit .envrc.local with your API keys"
    echo "     direnv allow"
  fi
fi

# ============================================
# PLAYWRIGHT MCP SERVER
# ============================================
# Playwright runs locally, no credentials needed
# Automatically configured in .mcp.json

# ============================================
# VERIFICATION
# ============================================
# Test that required variables are set
required_vars=(
  "JINA_API_KEY"
  "NOTION_API_TOKEN"
)

missing_vars=()
for var in "${required_vars[@]}"; do
  if [ -z "${!var}" ]; then
    missing_vars+=("$var")
  fi
done

if [ ${#missing_vars[@]} -gt 0 ]; then
  echo ""
  echo "⚠️  Missing required environment variables:"
  for var in "${missing_vars[@]}"; do
    echo "   - $var"
  done
  echo ""
  echo "   Check your 1Password vault or .envrc.local"
fi

# ============================================
# NOTES
# ============================================
#
# File Structure:
# - .envrc                    (this file - can be committed!)
# - .envrc.local             (manual fallback - NEVER commit)
# - .envrc.local.example     (template for team - commit this)
#
# Gitignore:
# Add to .gitignore:
#   .envrc.local
#
# Why .envrc can be committed:
# This file contains NO secrets - only references to 1Password vault.
# Secrets stay encrypted in your vault, never on disk!
#
# Rotating Keys:
# With 1Password:
#   op item edit "Jina.ai" api_key="new_key" --vault="${VAULT_NAME}"
#   direnv allow  # Updates instantly!
#
# With .envrc.local:
#   Edit .envrc.local manually
#   direnv allow
#
# ============================================
